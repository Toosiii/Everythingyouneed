<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist.min.js"></script>
    <title>Links</title>
</head>
<body class="bg-gray-100 dark:bg-gray-900 dark:text-white transition">

<div class="flex min-h-screen">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white dark:bg-gray-800 p-5">
        <h1 class="text-xl font-bold mb-4">Topics</h1>
        <div id="topicsList"></div>
    </aside>

    <!-- CONTENT -->
    <main class="flex-1 p-8">

        <div id="noTopicMessage">
            <h2 class="text-3xl font-bold mb-4">Topic ausw√§hlen</h2>
            <p class="text-gray-500">Links erscheinen nach Auswahl.</p>
        </div>

        <div id="topicContent" style="display: none;">
            <h2 id="topicTitle" class="text-3xl font-bold mb-4"></h2>

            <!-- SUCHFELD -->
            <form class="mb-4 flex gap-2" onsubmit="return false;">
                <input id="searchInput" name="search" placeholder="Suchen..."
                       class="border p-2 rounded text-black w-64"
                       onkeyup="filterLinks()">
                <button class="bg-blue-500 text-white px-4 rounded" onclick="filterLinks()">
                    OK
                </button>
            </form>

            <!-- TAGS -->
            <div id="tagsList" class="mb-4 flex gap-2 flex-wrap"></div>

            <!-- LINKS -->
            <div id="linksList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </div>

    </main>
</div>

<script>
let allData = [];
let currentTopicId = null;
let selectedTag = null;

// Load data from YAML
async function loadData() {
    try {
        const response = await fetch('links.yaml');
        const yamlText = await response.text();
        allData = jsyaml.load(yamlText);
        renderTopics();
        
        // Check URL params
        const params = new URLSearchParams(window.location.search);
        const topicParam = params.get('topic');
        const tagParam = params.get('tag');
        const searchParam = params.get('search');
        
        if (topicParam) {
            selectTopic(topicParam);
            if (tagParam) selectedTag = tagParam;
            if (searchParam) document.getElementById('searchInput').value = searchParam;
            filterLinks();
        }
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

// Render topics in sidebar
function renderTopics() {
    const topicsList = document.getElementById('topicsList');
    topicsList.innerHTML = '';
    
    allData.topics?.forEach(topic => {
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = topic.name;
        a.className = 'block px-3 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 mb-1 cursor-pointer';
        a.onclick = (e) => {
            e.preventDefault();
            selectTopic(topic.id);
            window.history.pushState(null, '', `?topic=${encodeURIComponent(topic.id)}`);
        };
        topicsList.appendChild(a);
    });
}

// Select a topic
function selectTopic(topicId) {
    currentTopicId = topicId;
    selectedTag = null;
    document.getElementById('searchInput').value = '';
    
    const current = allData.topics?.find(t => t.id === topicId);
    if (!current) return;
    
    document.getElementById('noTopicMessage').style.display = 'none';
    document.getElementById('topicContent').style.display = 'block';
    document.getElementById('topicTitle').textContent = current.name;
    
    renderTags(current);
    filterLinks();
}

// Render tags
function renderTags(topic) {
    const tagsList = document.getElementById('tagsList');
    tagsList.innerHTML = '';
    
    const allTags = {};
    topic.links?.forEach(link => {
        link.tags?.forEach(tag => {
            allTags[tag] = true;
        });
    });
    
    Object.keys(allTags).forEach(tag => {
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = tag;
        a.className = 'px-2 py-1 bg-gray-300 dark:bg-gray-700 rounded text-sm cursor-pointer hover:bg-gray-400 dark:hover:bg-gray-600';
        a.onclick = (e) => {
            e.preventDefault();
            selectedTag = selectedTag === tag ? null : tag;
            window.history.pushState(null, '', `?topic=${currentTopicId}&tag=${selectedTag || ''}`);
            filterLinks();
        };
        tagsList.appendChild(a);
    });
}

// Filter and display links
function filterLinks() {
    const current = allData.topics?.find(t => t.id === currentTopicId);
    if (!current) return;
    
    let links = current.links || [];
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    // Search filter
    if (search) {
        links = links.filter(l =>
            l.title.toLowerCase().includes(search) ||
            l.description.toLowerCase().includes(search)
        );
    }
    
    // Tag filter
    if (selectedTag) {
        links = links.filter(l =>
            l.tags?.includes(selectedTag)
        );
    }
    
    renderLinks(links);
}

// Render links
function renderLinks(links) {
    const linksList = document.getElementById('linksList');
    linksList.innerHTML = '';
    
    links.forEach(link => {
        const div = document.createElement('div');
        div.className = 'bg-white dark:bg-gray-800 p-4 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition';
        
        const title = document.createElement('h3');
        title.className = 'font-semibold text-lg';
        title.textContent = link.title;
        
        const url = document.createElement('a');
        url.href = link.url;
        url.target = '_blank';
        url.className = 'text-blue-500 text-sm break-all';
        url.textContent = link.url;
        
        const desc = document.createElement('p');
        desc.className = 'text-gray-600 dark:text-gray-300 text-sm mt-1';
        desc.textContent = link.description;
        
        div.appendChild(title);
        div.appendChild(url);
        div.appendChild(desc);
        linksList.appendChild(div);
    });
}

// Dark mode always enabled
document.documentElement.classList.add('dark');

// Load everything on page load
window.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
