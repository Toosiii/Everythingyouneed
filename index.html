<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="data.js"></script>
    <title>Links</title>
</head>
<body class="bg-gray-100 dark:bg-gray-900 dark:text-white transition">

<div class="flex min-h-screen">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white dark:bg-gray-800 p-5">
        <h1 class="text-xl font-bold mb-4">Topics</h1>
        <select id="topicsDropdown" class="w-full border p-2 rounded text-black dark:text-white dark:bg-gray-700" onchange="selectTopic(this.value)">
            <option value="">Select a topic...</option>
        </select>
        
        <!-- GAMES CATEGORIES -->
        <div id="gamesCategory" style="display: none; margin-top: 8px;">
            <h3 class="text-lg font-semibold mt-4 mb-2">Games</h3>
            <div id="gamesList" class="flex flex-col gap-1"></div>
        </div>
    </aside>

    <!-- CONTENT -->
    <main class="flex-1 p-8">

        <div id="noTopicMessage">
            <h2 class="text-3xl font-bold mb-4">Topic ausw√§hlen</h2>
            <p class="text-gray-500">Links erscheinen nach Auswahl.</p>
        </div>

        <div id="topicContent" style="display: none;">
            <h2 id="topicTitle" class="text-3xl font-bold mb-4"></h2>

            <!-- SUCHFELD -->
            <form class="mb-4 flex gap-2" onsubmit="return false;">
                <input id="searchInput" name="search" placeholder="Suchen..."
                       class="border p-2 rounded text-black w-64"
                       onkeyup="filterLinks()">
                <button class="bg-blue-500 text-white px-4 rounded" onclick="filterLinks()">
                    OK
                </button>
            </form>

            <!-- TAGS -->
            <div id="tagsList" class="mb-4 flex gap-2 flex-wrap"></div>

            <!-- LINKS -->
            <div id="linksList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </div>

    </main>
</div>

<script>
let currentTopicId = null;
let selectedTag = null;
let selectedGame = null;

// Initialize and load
function loadData() {
    renderTopics();
    
    // Check URL params
    const params = new URLSearchParams(window.location.search);
    const topicParam = params.get('topic');
    const tagParam = params.get('tag');
    const searchParam = params.get('search');
    
    if (topicParam) {
        selectTopic(topicParam);
        if (tagParam) selectedTag = tagParam;
        if (searchParam) document.getElementById('searchInput').value = searchParam;
        filterLinks();
    }
}

// Render topics in dropdown
function renderTopics() {
    const topicsDropdown = document.getElementById('topicsDropdown');
    topicsDropdown.innerHTML = '<option value="">Select a topic...</option>';
    
    allData.topics?.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.id;
        option.textContent = topic.name;
        topicsDropdown.appendChild(option);
    });
}

// Select a topic
function selectTopic(topicId) {
    if (!topicId) return; // Handle empty selection
    
    currentTopicId = topicId;
    selectedTag = null;
    selectedGame = null;
    document.getElementById('searchInput').value = '';
    document.getElementById('topicsDropdown').value = topicId;
    
    const current = allData.topics?.find(t => t.id === topicId);
    if (!current) return;
    
    document.getElementById('noTopicMessage').style.display = 'none';
    document.getElementById('topicContent').style.display = 'block';
    document.getElementById('topicTitle').textContent = current.name;
    
    // Show games category section only for Games topic
    const gamesCategorySection = document.getElementById('gamesCategory');
    if (topicId === 'Games') {
        gamesCategorySection.style.display = 'block';
        renderGameCategories(current);
    } else {
        gamesCategorySection.style.display = 'none';
    }
    
    renderTags(current);
    filterLinks();
    
    window.history.pushState(null, '', `?topic=${encodeURIComponent(topicId)}`);
}

// Render tags
function renderTags(topic) {
    const tagsList = document.getElementById('tagsList');
    tagsList.innerHTML = '';
    
    const allTags = {};
    topic.links?.forEach(link => {
        link.tags?.forEach(tag => {
            allTags[tag] = true;
        });
    });
    
    Object.keys(allTags).forEach(tag => {
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = tag;
        a.className = 'px-2 py-1 bg-gray-300 dark:bg-gray-700 rounded text-sm cursor-pointer hover:bg-gray-400 dark:hover:bg-gray-600';
        a.onclick = (e) => {
            e.preventDefault();
            selectedTag = selectedTag === tag ? null : tag;
            window.history.pushState(null, '', `?topic=${currentTopicId}&tag=${selectedTag || ''}`);
            filterLinks();
        };
        tagsList.appendChild(a);
    });
}

// Render game categories in sidebar
function renderGameCategories(topic) {
    const gamesList = document.getElementById('gamesList');
    gamesList.innerHTML = '';
    
    const games = new Set();
    topic.links?.forEach(link => {
        if (link.game) {
            games.add(link.game);
        }
    });
    
    games.forEach(game => {
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = game;
        a.className = 'px-3 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer text-sm';
        a.onclick = (e) => {
            e.preventDefault();
            selectedGame = selectedGame === game ? null : game;
            filterLinks();
        };
        gamesList.appendChild(a);
    });
}

// Filter and display links
function filterLinks() {
    const current = allData.topics?.find(t => t.id === currentTopicId);
    if (!current) return;
    
    let links = current.links || [];
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    // Search filter
    if (search) {
        links = links.filter(l =>
            l.title.toLowerCase().includes(search) ||
            l.description.toLowerCase().includes(search)
        );
    }
    
    // Tag filter
    if (selectedTag) {
        links = links.filter(l =>
            l.tags?.includes(selectedTag)
        );
    }
    
    // Game filter (for Games topic)
    if (selectedGame && currentTopicId === 'Games') {
        links = links.filter(l =>
            l.game === selectedGame
        );
    }
    
    renderLinks(links);
}

// Render links
function renderLinks(links) {
    const linksList = document.getElementById('linksList');
    linksList.innerHTML = '';
    
    links.forEach(link => {
        const div = document.createElement('div');
        div.className = 'bg-white dark:bg-gray-800 p-4 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition';
        
        const title = document.createElement('h3');
        title.className = 'font-semibold text-lg';
        title.textContent = link.title;
        
        const url = document.createElement('a');
        url.href = link.url;
        url.target = '_blank';
        url.className = 'text-blue-500 text-sm break-all';
        url.textContent = link.url;
        
        const desc = document.createElement('p');
        desc.className = 'text-gray-600 dark:text-gray-300 text-sm mt-1';
        desc.textContent = link.description;
        
        div.appendChild(title);
        div.appendChild(url);
        div.appendChild(desc);
        linksList.appendChild(div);
    });
}

// Dark mode always enabled
document.documentElement.classList.add('dark');

// Load everything on page load
window.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
